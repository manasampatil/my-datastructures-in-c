#include <stdio.h>
#include <stdlib.h>
#include <string.h>

char** split(char *str, char delim, int *count) {
    char **tokens = NULL;
    char *start = str;
    char *ptr = str;
    int token_count = 0;

    while (*ptr) {
        if (*ptr == delim) {
            // Calculate token length
            int len = ptr - start;
            if (len > 0) { // skip empty tokens
                char *token = malloc(len + 1);
                if (!token) {
                    perror("malloc");
                    // cleanup
                    for (int i = 0; i < token_count; i++)
                        free(tokens[i]);
                    free(tokens);
                    return NULL;
                }
                strncpy(token, start, len);
                token[len] = '\0';

                // Add token to array
                char **tmp = realloc(tokens, (token_count + 1) * sizeof(char *));
                if (!tmp) {
                    perror("realloc");
                    free(token);
                    for (int i = 0; i < token_count; i++)
                        free(tokens[i]);
                    free(tokens);
                    return NULL;
                }
                tokens = tmp;
                tokens[token_count++] = token;
            }
            start = ptr + 1;
        }
        ptr++;
    }
    if (ptr != start) {
        int len = ptr - start;
        char *token = malloc(len + 1);
        strncpy(token, start, len);
        token[len] = '\0';
        char **tmp = realloc(tokens, (token_count + 1) * sizeof(char *));
        tokens = tmp;
        tokens[token_count++] = token;
    }

    *count = token_count;
    return tokens;
}
int main() {
    char input[] = "apple,banana,cherry";
    int count;
    char **result = split(input, ',', &count);

    for (int i = 0; i < count; i++) {
        printf("Token[%d]: %s\n", i, result[i]);
        free(result[i]);
    }
    free(result);

    return 0;
}
